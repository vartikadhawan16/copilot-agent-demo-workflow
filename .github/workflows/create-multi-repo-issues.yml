name: Create Issues on Multiple Repos

on:
  workflow_dispatch: # Manual trigger from Actions tab

jobs:
  create-issues:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Install GitHub CLI
      - name: Set up GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh
          gh auth login --with-token <<< "${{ secrets.GH_PAT }}"

      # Step 2: Create Issues on Multiple Repositories and assign to copilot
      - name: Create Issues and Assign to Copilot
        env:
          ASSIGNEE: "copilot"
        run: |
          # Define issue title and body
          ISSUE_TITLE="Sync Docker and Gradle Configurations"
          ISSUE_BODY=$'Please update the repository to include Docker-related files and Gradle build updates based on reference standards.\n\nReference Repo: https://github.com/vartikadhawan16/copilot-agent-demo-org\nTarget Repo: This repository\n\nEnsure consistency in Dockerfile, docker-compose, Gradle build files, and related scripts.'

          # List of repositories to create issues on
          REPOS=("vartikadhawan16/copilot-agent-demo-user")

          # Loop through repositories
          for REPO in "${REPOS[@]}"; do
            echo "Processing $REPO"

            # Create label if it doesn't exist
            gh label create "copilot-update" \
              --color "0E8A16" \
              --description "Triggers Copilot automation" \
              --repo "$REPO" || echo "Label already exists on $REPO"

            # Create issue without assignment first to avoid hard failures
            ISSUE_URL="$(gh issue create --repo "$REPO" \
              --title "$ISSUE_TITLE" \
              --body "$ISSUE_BODY" \
              --label "copilot-update" | tail -n1)"

            if [[ -z "$ISSUE_URL" ]]; then
              echo "Failed to create issue on $REPO"
              continue
            fi

            echo "Issue created: $ISSUE_URL"
            ISSUE_NUMBER="${ISSUE_URL##*/}"

            # Try to assign to copilot; if it fails, leave a note
            if gh issue edit "$ISSUE_NUMBER" --repo "$REPO" --add-assignee "$ASSIGNEE"; then
              echo "Assigned issue #$ISSUE_NUMBER to $ASSIGNEE on $REPO"
            else
              echo "Could not assign to $ASSIGNEE on $REPO. Leaving a comment instead."
              gh issue comment "$ISSUE_NUMBER" --repo "$REPO" --body "Heads up: Could not auto-assign to @${ASSIGNEE}. Please ensure the user has access to this repository and assign manually."
            fi
          done
