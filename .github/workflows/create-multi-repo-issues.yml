name: Create Issues on Multiple Repos

on:
  workflow_dispatch: # Manual trigger from Actions tab

jobs:
  create-issues:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Install GitHub CLI
      - name: Set up GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh
          gh auth login --with-token <<< "${{ secrets.GH_PAT }}"

      # Step 2: Create Issues on Multiple Repositories and assign to copilot
      - name: Create Issues and Assign to Copilot
        run: |
          # Define issue title and body
          ISSUE_TITLE="Update Repository: Add Docker & Gradle Enhancements, Remove Manifests"
          ISSUE_BODY=$'Update the repository to: Add Docker-related files and ensure consistency with reference standards.\n\nUpdate Gradle build files and related scripts for alignment with best practices.\n\nRemove manifest and autoscaler manifest files from the project.\n\nReference Repository:https://github.com/vartikadhawan16/copilot-agent-demo-org'

          # List of repositories to create issues on
          REPOS=("vartikadhawan16/copilot-agent-demo-user" "vartikadhawan16/copilot-agent-demo-customer" "vartikadhawan16/copilot-agent-demo-product")

          # Loop through repositories
          for REPO in "${REPOS[@]}"; do
            echo "Processing $REPO"

            # Create label if it doesn't exist
            gh label create "copilot-update" \
              --color "0E8A16" \
              --description "Triggers Copilot automation" \
              --repo "$REPO" --force || echo "Label already exists on $REPO"

            # Create issue without assignment first to avoid hard failures
            ISSUE_URL="$(gh issue create --repo "$REPO" \
              --title "$ISSUE_TITLE" \
              --body "$ISSUE_BODY" \
              --label "copilot-update" | tail -n1)"

            if [[ -z "$ISSUE_URL" ]]; then
              echo "Failed to create issue on $REPO"
              continue
            fi

            echo "Issue created: $ISSUE_URL"
            ISSUE_NUMBER="${ISSUE_URL##*/}"
          done
